# VSCode拡張機能 トラブルシューティングガイド

## 📚 このドキュメントについて

このガイドは、VSCode拡張機能の開発中に発生する一般的な問題を**自力で解決できるようになる**ことを目的としています。単なる解決方法の羅列ではなく、**問題の原因を特定するための考え方**と**デバッグスキル**を体系的に学べる内容になっています。

---

## 🎯 今回遭遇した問題

### 現象
- サイドバーにPrism Codeが表示されない
- 右クリックから呼び出しても空のウィンドウが開かれる

### 根本原因
**`activationEvents`の設定不足**

package.jsonで以下のように設定されていました：

```json
"activationEvents": [
  "onLanguage:typescript",
  "onLanguage:typescriptreact"
]
```

この設定では、**TypeScriptファイルを開いた時のみ**拡張機能がアクティベートされます。サイドバーを開いただけでは拡張機能が起動しないため、WebViewProviderが登録されず、空のウィンドウが表示されていました。

### 解決策
`onView:prismcode.aiChat`を追加することで、サイドバーのビューを開いた時に拡張機能がアクティベートされるようになります：

```json
"activationEvents": [
  "onView:prismcode.aiChat",  // ← 追加
  "onLanguage:typescript",
  "onLanguage:typescriptreact"
]
```

**注意**: VSCode 1.74以降では、`onView:`は`contributes.views`から自動的に推論されるため、明示的に書かなくても動作しますが、古いバージョンとの互換性のために残しておくことを推奨します。

---

## 🔍 問題解決の思考プロセス

### 1. 問題を正確に把握する

❌ 悪い例: 「動かない」
✅ 良い例:
- サイドバーのアイコンは表示されるか？
- アイコンをクリックしたらどうなるか？
- エラーメッセージは出ているか？
- 開発者ツールのコンソールにエラーは？

**今回のケース**:
- サイドバーにアイコン自体が表示されない → package.jsonの`viewsContainers`または`views`の設定問題
- アイコンはあるが中身が空 → WebViewProviderの登録問題、またはアクティベーション問題

### 2. レイヤーごとに切り分ける

VSCode拡張機能は以下のレイヤーに分かれています：

```
┌─────────────────────────────────┐
│ 1. VSCode Extension Host        │  ← 拡張機能のアクティベーション
├─────────────────────────────────┤
│ 2. Extension Manifest           │  ← package.json の設定
├─────────────────────────────────┤
│ 3. Extension Code               │  ← extension.ts の実装
├─────────────────────────────────┤
│ 4. WebView Provider             │  ← WebViewProvider の実装
├─────────────────────────────────┤
│ 5. WebView UI                   │  ← HTML/CSS/JavaScript
└─────────────────────────────────┘
```

**上から順番に確認する**のが鉄則です。下のレイヤー（WebView UI）を確認する前に、上のレイヤー（アクティベーション、設定）が正しいか確認しましょう。

### 3. チェックリストに沿って確認する

以下のチェックリストを順番に確認していきます：

#### ✅ レイヤー1: 拡張機能がアクティベートされているか？

**確認方法**:
```typescript
// extension.ts の activate 関数
export function activate(context: vscode.ExtensionContext) {
  console.log('Prism Code が起動しました！'); // ← このログが出るか確認
}
```

**ログの確認場所**:
- `Help` → `Toggle Developer Tools` → `Console`タブ
- "Prism Code が起動しました！" が表示されるか確認

**もし表示されない場合**:
→ `activationEvents`の設定を確認（後述）

#### ✅ レイヤー2: package.json の設定が正しいか？

**確認項目**:

1. **viewsContainers**: サイドバーアイコンの定義

```json
"viewsContainers": {
  "activitybar": [
    {
      "id": "prismcode-sidebar",      // ← ユニークなID
      "title": "Prism Code",          // ← サイドバーのタイトル
      "icon": "media/icon.svg"        // ← アイコンファイルのパス（存在するか確認）
    }
  ]
}
```

**確認コマンド**:
```bash
ls -la media/icon.svg  # アイコンファイルが存在するか確認
```

2. **views**: サイドバー内のビューの定義

```json
"views": {
  "prismcode-sidebar": [  // ← viewsContainers の id と一致するか確認
    {
      "type": "webview",
      "id": "prismcode.aiChat",  // ← WebViewProvider の viewType と一致するか確認
      "name": "AI アシスタント"
    }
  ]
}
```

3. **activationEvents**: 拡張機能をいつアクティベートするか

```json
"activationEvents": [
  "onView:prismcode.aiChat",       // ← views の id と一致するか確認
  "onLanguage:typescript",
  "onLanguage:typescriptreact"
]
```

**主要な activationEvents**:

| イベント | 説明 | 使用例 |
|---------|------|--------|
| `onView:viewId` | ビューが開かれた時 | サイドバービューを持つ拡張機能 |
| `onLanguage:languageId` | 特定の言語ファイルを開いた時 | 言語サポート拡張機能 |
| `onCommand:commandId` | コマンドが実行された時 | コマンドパレットから呼び出す拡張機能 |
| `onStartupFinished` | VSCode起動直後（遅延あり） | 常駐型拡張機能 |
| `*` | VSCode起動時（非推奨） | パフォーマンス低下の原因 |

**推奨**: 必要最小限のイベントのみを指定し、`*`は避ける

#### ✅ レイヤー3: Extension Code が正しいか？

**確認項目**:

1. **WebViewProvider の viewType が一致するか**

```typescript
// AIChatViewProvider.ts
export class AIChatViewProvider implements vscode.WebviewViewProvider {
  public static readonly viewType = 'prismcode.aiChat';  // ← package.json の views.id と一致
}
```

2. **WebViewProvider が正しく登録されているか**

```typescript
// extension.ts
export function activate(context: vscode.ExtensionContext) {
  const aiChatProvider = new AIChatViewProvider(context.extensionUri);
  context.subscriptions.push(
    vscode.window.registerWebviewViewProvider(
      AIChatViewProvider.viewType,  // ← 'prismcode.aiChat'
      aiChatProvider
    )
  );
}
```

**デバッグ方法**:
```typescript
export function activate(context: vscode.ExtensionContext) {
  console.log('1. activate 開始');

  const aiChatProvider = new AIChatViewProvider(context.extensionUri);
  console.log('2. AIChatViewProvider 作成完了');

  const registration = vscode.window.registerWebviewViewProvider(
    AIChatViewProvider.viewType,
    aiChatProvider
  );
  console.log('3. WebViewProvider 登録完了:', AIChatViewProvider.viewType);

  context.subscriptions.push(registration);
  console.log('4. subscriptions に追加完了');
}
```

3. **コンパイルエラーがないか**

```bash
pnpm run compile
```

エラーが出た場合は、必ず解決してから進めましょう。

#### ✅ レイヤー4: WebViewProvider の実装が正しいか？

**確認項目**:

1. **resolveWebviewView が正しく実装されているか**

```typescript
export class AIChatViewProvider implements vscode.WebviewViewProvider {
  public resolveWebviewView(
    webviewView: vscode.WebviewView,
    _context: vscode.WebviewViewResolveContext,
    _token: vscode.CancellationToken
  ): void {
    console.log('resolveWebviewView が呼ばれました');  // ← このログが出るか確認

    this._view = webviewView;

    webviewView.webview.options = {
      enableScripts: true,  // ← JavaScriptを有効化
      localResourceRoots: [this._extensionUri],  // ← ローカルリソースへのアクセスを許可
    };

    webviewView.webview.html = this._getHtmlForWebview(webviewView.webview);
    console.log('HTML を設定しました');
  }
}
```

**もし `resolveWebviewView が呼ばれました` が表示されない場合**:
→ アクティベーションの問題（レイヤー1, 2を再確認）

2. **HTML が正しく生成されているか**

```typescript
private _getHtmlForWebview(webview: vscode.Webview): string {
  const html = `<!DOCTYPE html>
    <html>
      <body>
        <h1>テスト</h1>
      </body>
    </html>`;

  console.log('生成されたHTML:', html.substring(0, 100));  // ← HTMLの一部をログ出力
  return html;
}
```

#### ✅ レイヤー5: WebView UI が正しく表示されるか？

**確認方法**:

1. **WebView を右クリック → `Inspect Element`**
   - Developer Tools が開く
   - `Console` タブでエラーを確認
   - `Elements` タブでHTML構造を確認

2. **Content Security Policy (CSP) エラーがないか確認**

```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'none';
               style-src ${webview.cspSource} 'unsafe-inline';
               script-src 'nonce-${nonce}';" />
```

**よくあるCSPエラー**:
- `Refused to load the script because it violates the following Content Security Policy directive`
  → `script-src`にnonceを追加し忘れている

**スクリプトにnonceを追加**:
```html
<script nonce="${nonce}">
  // JavaScriptコード
</script>
```

---

## 🛠️ デバッグスキル習得ガイド

### スキル1: ログを活用した段階的デバッグ

**基本原則**: 各処理の前後でログを出力し、どこまで実行されているか確認する

```typescript
export function activate(context: vscode.ExtensionContext) {
  console.log('=== Prism Code: アクティベーション開始 ===');

  try {
    console.log('[1] AIChatViewProvider 作成中...');
    const aiChatProvider = new AIChatViewProvider(context.extensionUri);
    console.log('[1] ✓ AIChatViewProvider 作成完了');

    console.log('[2] WebViewProvider 登録中...');
    const registration = vscode.window.registerWebviewViewProvider(
      AIChatViewProvider.viewType,
      aiChatProvider
    );
    console.log('[2] ✓ WebViewProvider 登録完了');

    context.subscriptions.push(registration);
    console.log('[3] ✓ subscriptions に追加完了');

    console.log('=== Prism Code: アクティベーション成功 ===');
  } catch (error) {
    console.error('=== Prism Code: アクティベーションエラー ===', error);
  }
}
```

**ログの読み方**:
- `[1] ✓ AIChatViewProvider 作成完了` まで出ている → AIChatViewProviderの作成は成功
- `[2]` が出ていない → `registerWebviewViewProvider` でエラーが発生している可能性

### スキル2: VSCode Developer Tools の活用

**開き方**:
- `Help` → `Toggle Developer Tools`（Extension Host側）
- WebView を右クリック → `Inspect Element`（WebView側）

**重要なタブ**:

1. **Console**: ログとエラーメッセージを確認
2. **Sources**: ブレークポイントを設定してステップ実行
3. **Network**: リソースの読み込み状況を確認
4. **Elements**: HTMLの構造を確認

**フィルタリング**:
- Consoleタブで「Prism」と検索すると、自分の拡張機能のログだけが表示される

### スキル3: デバッグ実行の活用

**launch.json の確認**:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Run Extension",
      "type": "extensionHost",
      "request": "launch",
      "args": [
        "--extensionDevelopmentPath=${workspaceFolder}"
      ],
      "outFiles": [
        "${workspaceFolder}/out/**/*.js"
      ],
      "preLaunchTask": "${defaultBuildTask}"
    }
  ]
}
```

**使い方**:
1. `extension.ts` にブレークポイントを設定（行番号の左をクリック）
2. `F5`キーを押してデバッグ実行
3. ブレークポイントで停止したら、変数の値を確認

**確認できる情報**:
- 変数の値
- 関数の引数
- 実行フロー

### スキル4: 段階的な機能追加とテスト

**悪い例**: すべての機能を一度に実装してからテスト
→ 問題が発生した時、原因の特定が困難

**良い例**: 最小限の機能から始めて、動作確認しながら段階的に追加

```typescript
// ステップ1: 最小限のHTMLを表示
private _getHtmlForWebview(webview: vscode.Webview): string {
  return `<!DOCTYPE html>
    <html>
      <body><h1>動作確認</h1></body>
    </html>`;
}

// ステップ2: スタイルを追加
private _getHtmlForWebview(webview: vscode.Webview): string {
  return `<!DOCTYPE html>
    <html>
      <head>
        <style>
          body { color: var(--vscode-foreground); }
        </style>
      </head>
      <body><h1>動作確認</h1></body>
    </html>`;
}

// ステップ3: JavaScriptを追加
// ...
```

各ステップで必ず動作確認を行い、問題があればその場で解決します。

---

## 📊 よくある問題と解決方法

### 問題1: サイドバーにアイコンが表示されない

**チェックリスト**:
1. [ ] `package.json`の`viewsContainers`が正しいか
2. [ ] `icon`ファイルが存在するか（`ls -la media/icon.svg`）
3. [ ] 拡張機能がコンパイルされているか（`pnpm run compile`）
4. [ ] VSCodeを再起動したか

**解決方法**:
```bash
# アイコンファイルの確認
ls -la media/icon.svg

# 再ビルド
pnpm run compile

# VSCodeを再起動
```

### 問題2: サイドバーは表示されるが、中身が空

**原因の切り分け**:

**ケース1**: `activationEvents`の不足
→ サイドバーを開いても拡張機能がアクティベートされない

**解決方法**:
```json
"activationEvents": [
  "onView:prismcode.aiChat"  // ← 追加
]
```

**ケース2**: WebViewProviderの登録ミス
→ `viewType`が一致していない

**確認方法**:
```typescript
// AIChatViewProvider.ts
public static readonly viewType = 'prismcode.aiChat';

// package.json
"views": {
  "prismcode-sidebar": [
    {
      "id": "prismcode.aiChat"  // ← 一致するか確認
    }
  ]
}
```

**ケース3**: HTMLの生成エラー
→ `_getHtmlForWebview`で例外が発生している

**確認方法**:
```typescript
private _getHtmlForWebview(webview: vscode.Webview): string {
  try {
    const html = `...`;
    console.log('HTML生成成功');
    return html;
  } catch (error) {
    console.error('HTML生成エラー:', error);
    return '<html><body>エラーが発生しました</body></html>';
  }
}
```

### 問題3: ビルドエラー: "File is not under 'rootDir'"

**原因**: `tsconfig.json`の設定で、コンパイル対象外のファイルが含まれている

**解決方法**:
```json
// tsconfig.json
{
  "exclude": [
    "node_modules",
    ".vscode-test",
    "webview-ui",  // ← WebView UIはViteでビルドするため除外
    "sample",
    "out"
  ]
}
```

### 問題4: WebView UIに何も表示されない

**原因の切り分け**:

**ケース1**: WebView UIがビルドされていない

**確認方法**:
```bash
ls -la webview-ui/build/
# index.html, assets/index.js, assets/index.css が存在するか確認
```

**解決方法**:
```bash
pnpm run compile:webview
```

**ケース2**: ビルドされたファイルのパスが間違っている

**確認方法**:
```typescript
// WebViewProvider で正しいパスを指定しているか確認
const scriptUri = webview.asWebviewUri(
  vscode.Uri.joinPath(this._extensionUri, 'webview-ui', 'build', 'assets', 'index.js')
);
```

### 問題5: Content Security Policy エラー

**エラーメッセージ例**:
```
Refused to load the script 'vscode-webview://...' because it violates the following Content Security Policy directive
```

**原因**: CSPが厳しすぎる、またはnonceが設定されていない

**解決方法**:
```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'none';
               style-src ${webview.cspSource} 'unsafe-inline';
               script-src 'nonce-${nonce}';" />

<!-- スクリプトにnonceを追加 -->
<script nonce="${nonce}">
  const vscode = acquireVsCodeApi();
</script>
```

---

## 🎓 トラブルシューティングの基本原則

### 原則1: 問題を細分化する

大きな問題を小さな問題に分解し、一つずつ解決していきます。

**例**: 「WebViewに何も表示されない」
1. 拡張機能はアクティベートされているか？
2. WebViewProviderは登録されているか？
3. `resolveWebviewView`は呼ばれているか？
4. HTMLは生成されているか？
5. WebView UIのビルドは成功しているか？

### 原則2: 仮説検証サイクルを回す

1. **仮説を立てる**: 「activationEventsが足りないのでは？」
2. **検証方法を考える**: 「Developer Toolsでログを確認する」
3. **実験する**: 「`onView:prismcode.aiChat`を追加してみる」
4. **結果を確認する**: 「サイドバーが表示されるようになった → 仮説が正しかった」

### 原則3: 変更は一度に一つだけ

複数の変更を同時に行うと、どの変更が効果があったのか分からなくなります。

**悪い例**:
- activationEventsを変更
- WebViewProviderのコードを修正
- package.jsonのviewsを変更
→ どれが原因だったのか不明

**良い例**:
- activationEventsを変更 → テスト → 結果確認
- まだ動かない場合、次の変更を試す

### 原則4: 公式ドキュメントを参照する

VSCode Extension APIの公式ドキュメントは非常に充実しています：

- [VSCode Extension API](https://code.visualstudio.com/api)
- [WebView API Guide](https://code.visualstudio.com/api/extension-guides/webview)
- [Activation Events](https://code.visualstudio.com/api/references/activation-events)

---

## 🚀 次のステップ

このガイドで学んだスキルを活かして、以下のような問題にも対応できるようになります：

### レベル1: 基本的なデバッグ
- [ ] ログを活用して問題箇所を特定できる
- [ ] Developer Toolsでエラーメッセージを確認できる
- [ ] package.jsonの設定ミスを発見できる

### レベル2: 中級デバッグ
- [ ] ブレークポイントを使ったステップ実行ができる
- [ ] WebView ↔ Extension 間の通信をデバッグできる
- [ ] パフォーマンス問題を特定できる

### レベル3: 上級デバッグ
- [ ] TypeScript Compiler APIのエラーをデバッグできる
- [ ] React Flowのレイアウトアルゴリズムをカスタマイズできる
- [ ] メモリリークを検出・修正できる

---

## 📚 参考資料

### 公式ドキュメント
- [VSCode Extension API](https://code.visualstudio.com/api)
- [WebView API](https://code.visualstudio.com/api/extension-guides/webview)
- [Activation Events](https://code.visualstudio.com/api/references/activation-events)
- [Contribution Points](https://code.visualstudio.com/api/references/contribution-points)

### デバッグツール
- [VSCode Extension Samples](https://github.com/microsoft/vscode-extension-samples) - サンプルコード集
- [VSCode Webview UI Toolkit](https://github.com/microsoft/vscode-webview-ui-toolkit) - WebView UI用コンポーネント

### トラブルシューティングリソース
- [VSCode Extension FAQ](https://code.visualstudio.com/api/working-with-extensions/testing-extension)
- [Stack Overflow - vscode-extensions](https://stackoverflow.com/questions/tagged/vscode-extensions)

---

## ✅ まとめ

### 今回学んだこと

1. **activationEvents の重要性**
   - 拡張機能をいつアクティベートするかを制御する
   - サイドバービューを持つ場合は`onView:viewId`が必要（VSCode 1.74以降は自動推論）

2. **レイヤー思考**
   - 問題を上位レイヤーから順番に切り分ける
   - 下のレイヤーを確認する前に、上のレイヤーが正しいか確認

3. **段階的デバッグ**
   - ログを活用して、どこまで実行されているか確認
   - 一度に一つの変更を行い、結果を確認

4. **Developer Toolsの活用**
   - Extension HostとWebViewでそれぞれDeveloper Toolsを開ける
   - ログ、エラーメッセージ、ネットワーク、要素を確認できる

### 次回同じような問題に遭遇したら

1. **まず落ち着く** - 焦らず、問題を正確に把握する
2. **このガイドを開く** - チェックリストに沿って確認
3. **ログを追加する** - 問題箇所を特定
4. **仮説を立てて検証** - 一つずつ試す
5. **解決したら記録** - 次回のために学びを残す

---

**作成日**: 2026-02-13
**バージョン**: 1.0.0
**対象**: Prism Code開発者
